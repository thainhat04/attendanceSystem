const contractABI = [
  {
    inputs: [],
    stateMutability: "nonpayable",
    type: "constructor",
  },
  {
    anonymous: false,
    inputs: [
      {
        indexed: false,
        internalType: "uint256",
        name: "classId",
        type: "uint256",
      },
      {
        indexed: true,
        internalType: "address",
        name: "user",
        type: "address",
      },
      {
        indexed: false,
        internalType: "bool",
        name: "isPresent",
        type: "bool",
      },
      {
        indexed: false,
        internalType: "uint256",
        name: "timestamp",
        type: "uint256",
      },
    ],
    name: "AttendanceMarked",
    type: "event",
  },
  {
    inputs: [],
    name: "getApprovedClasses",
    outputs: [
      { internalType: "uint256[]", name: "", type: "uint256[]" },
      { internalType: "string[]", name: "", type: "string[]" },
      { internalType: "address[]", name: "", type: "address[]" },
    ],
    stateMutability: "view",
    type: "function",
  },
  {
    anonymous: false,
    inputs: [
      {
        indexed: false,
        internalType: "uint256",
        name: "classId",
        type: "uint256",
      },
    ],
    name: "ClassApproved",
    type: "event",
  },
  {
    anonymous: false,
    inputs: [
      {
        indexed: false,
        internalType: "uint256",
        name: "classId",
        type: "uint256",
      },
      {
        indexed: false,
        internalType: "string",
        name: "name",
        type: "string",
      },
      {
        indexed: false,
        internalType: "address",
        name: "teacher",
        type: "address",
      },
    ],
    name: "ClassPending",
    type: "event",
  },
  {
    anonymous: false,
    inputs: [
      {
        indexed: false,
        internalType: "uint256",
        name: "classId",
        type: "uint256",
      },
    ],
    name: "ClassRejected",
    type: "event",
  },
  {
    anonymous: false,
    inputs: [
      {
        indexed: false,
        internalType: "uint256",
        name: "classId",
        type: "uint256",
      },
      {
        indexed: false,
        internalType: "address",
        name: "student",
        type: "address",
      },
    ],
    name: "StudentAdded",
    type: "event",
  },
  {
    inputs: [],
    name: "classCount",
    outputs: [
      {
        internalType: "uint256",
        name: "",
        type: "uint256",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "",
        type: "uint256",
      },
    ],
    name: "classes",
    outputs: [
      {
        internalType: "string",
        name: "name",
        type: "string",
      },
      {
        internalType: "address",
        name: "teacher",
        type: "address",
      },
      {
        internalType: "bool",
        name: "isApproved",
        type: "bool",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
  {
    inputs: [],
    name: "owner",
    outputs: [
      {
        internalType: "address",
        name: "",
        type: "address",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
  {
    inputs: [],
    name: "pendingClassCount",
    outputs: [
      {
        internalType: "uint256",
        name: "",
        type: "uint256",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "",
        type: "uint256",
      },
    ],
    name: "pendingClasses",
    outputs: [
      {
        internalType: "string",
        name: "name",
        type: "string",
      },
      {
        internalType: "address",
        name: "teacher",
        type: "address",
      },
      {
        internalType: "bool",
        name: "isApproved",
        type: "bool",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
  {
    inputs: [
      {
        internalType: "string",
        name: "_name",
        type: "string",
      },
    ],
    name: "createClass",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [],
    name: "getPendingClasses",
    outputs: [
      {
        internalType: "uint256[]",
        name: "",
        type: "uint256[]",
      },
      {
        internalType: "string[]",
        name: "",
        type: "string[]",
      },
      {
        internalType: "address[]",
        name: "",
        type: "address[]",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "_pendingClassId",
        type: "uint256",
      },
    ],
    name: "approveClass",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [],
    name: "getAdmin",
    outputs: [
      {
        internalType: "address",
        name: "",
        type: "address",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "_pendingClassId",
        type: "uint256",
      },
    ],
    name: "rejectClass",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "_classId",
        type: "uint256",
      },
      {
        internalType: "address",
        name: "_student",
        type: "address",
      },
    ],
    name: "addStudent",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "_classId",
        type: "uint256",
      },
      {
        internalType: "bool",
        name: "_isPresent",
        type: "bool",
      },
    ],
    name: "markAttendance",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "_classId",
        type: "uint256",
      },
      {
        internalType: "address",
        name: "_student",
        type: "address",
      },
    ],
    name: "getAttendanceCount",
    outputs: [
      {
        internalType: "uint256",
        name: "",
        type: "uint256",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "_classId",
        type: "uint256",
      },
      {
        internalType: "address",
        name: "_student",
        type: "address",
      },
      {
        internalType: "uint256",
        name: "index",
        type: "uint256",
      },
    ],
    name: "getAttendanceRecord",
    outputs: [
      {
        internalType: "bool",
        name: "",
        type: "bool",
      },
      {
        internalType: "uint256",
        name: "",
        type: "uint256",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "_classId",
        type: "uint256",
      },
    ],
    name: "getStudents",
    outputs: [
      {
        internalType: "address[]",
        name: "",
        type: "address[]",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
  {
    inputs: [],
    name: "getTotalClasses",
    outputs: [
      {
        internalType: "uint256",
        name: "",
        type: "uint256",
      },
    ],
    stateMutability: "view",
    type: "function",
    constant: true,
  },
];

const contractAddress = "0x8fd75Fd24Ec2976AcA0FeDE6b617A1f8248b03b0";

let web3;
let contract;
let accounts;

// Khi t√†i li·ªáu HTML ƒë√£ t·∫£i xong
document.addEventListener("DOMContentLoaded", async function () {
  const params = new URLSearchParams(window.location.search);
  const role = params.get("role"); // L·∫•y vai tr√≤ t·ª´ URL
  const teacherPanel = document.getElementById("teacherPanel");
  const studentPanel = document.getElementById("studentPanel");
  const walletAddressP = document.getElementById("walletAddress");
  const adminPanel = document.getElementById("adminPanel");

  if (window.ethereum) {
    try {
      web3 = new Web3(window.ethereum);
      accounts = await web3.eth.getAccounts();
      contract = new web3.eth.Contract(contractABI, contractAddress);
      console.log("üìú H·ª£p ƒë·ªìng ƒë√£ t·∫£i:", contract);
    } catch (error) {
      console.error("‚ùå L·ªói khi kh·ªüi t·∫°o web3 ho·∫∑c h·ª£p ƒë·ªìng:", error);
      alert("‚ùå L·ªói khi kh·ªüi t·∫°o web3 ho·∫∑c h·ª£p ƒë·ªìng. Vui l√≤ng th·ª≠ l·∫°i.");
      return;
    }
  } else {
    alert("‚ö†Ô∏è B·∫°n c·∫ßn c√†i MetaMask ƒë·ªÉ s·ª≠ d·ª•ng!");
    return;
  }

  if (!contract) {
    console.error("‚ùå H·ª£p ƒë·ªìng ch∆∞a ƒë∆∞·ª£c t·∫£i.");
    return;
  }

  if (!role) {
    // N·∫øu kh√¥ng c√≥ role, quay v·ªÅ trang ch·ªçn vai tr√≤
    window.location.href = "role.html";
  }

  // Hi·ªÉn th·ªã giao di·ªán theo vai tr√≤
  if (role === "teacher") {
    teacherPanel.style.display = "block";
    await loadApprovedClasses("classListForAddingStudent"); // Load danh s√°ch l·ªõp ƒë√£
  } else if (role === "student") {
    studentPanel.style.display = "block";
    await loadApprovedClasses("classList"); // Load danh s√°ch l·ªõp cho sinh vi√™n
  } else if (role === "admin") {
    adminPanel.style.display = "block";
    await loadPendingClasses(); // Load danh s√°ch l·ªõp ch·ªù duy·ªát khi v√†o admin
  }

  const connectWalletButton = document.getElementById("connectWallet");
  if (connectWalletButton) {
    connectWalletButton.addEventListener("click", connectWallet);
  }

  const createClassButton = document.getElementById("createClass");
  if (createClassButton) {
    createClassButton.addEventListener("click", createClass);
  }

  const addStudentButton = document.getElementById("addStudent");
  if (addStudentButton) {
    addStudentButton.addEventListener("click", addStudent);
  }

  const markAttendanceButton = document.getElementById("markAttendance");
  if (markAttendanceButton) {
    markAttendanceButton.addEventListener("click", markAttendance);
  }

  const viewAttendanceButton = document.getElementById("viewAttendance");
  if (viewAttendanceButton) {
    viewAttendanceButton.addEventListener("click", viewAttendance);
  }

  // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
  const studentListModal = document.getElementById("studentListModal");
  const closeModal = document.querySelector(".close");

  // M·ªü modal khi nh·∫•n n√∫t "Danh s√°ch c√°c h·ªçc sinh"
  const listStudentButton = document.getElementById("listStudent");
  if (listStudentButton) {
    listStudentButton.addEventListener("click", async () => {
      try {
        const classId = document.getElementById(
          "classListForAddingStudent"
        ).value;
        const optionData = document.querySelector(`option[value="${classId}"]`);
        if (!classId) return showSnackbar("‚ö†Ô∏è Vui l√≤ng ch·ªçn l·ªõp!");

        console.log(classId);
        // L·∫•y danh s√°ch sinh vi√™n t·ª´ h·ª£p ƒë·ªìng
        const students = await contract.methods.getStudents(classId).call();

        // X√≥a d·ªØ li·ªáu c≈© trong b·∫£ng
        const studentTableBody = document.querySelector("#studentTable tbody");
        studentTableBody.innerHTML = "";

        // Th√™m t·ª´ng sinh vi√™n v√†o b·∫£ng
        students.forEach((student) => {
          const row = document.createElement("tr");
          const addressCell = document.createElement("td");
          const classCell = document.createElement("td");

          addressCell.textContent = student;
          classCell.textContent = `${optionData.dataset.className}`;

          row.appendChild(addressCell);
          row.appendChild(classCell);
          studentTableBody.appendChild(row);
        });

        studentListModal.style.display = "block";
      } catch (error) {
        console.error("‚ùå L·ªói khi l·∫•y danh s√°ch sinh vi√™n:", error);
        showSnackbar("‚ùå L·ªói khi l·∫•y danh s√°ch sinh vi√™n!");
      }
    });
  }

  if (closeModal) {
    closeModal.addEventListener("click", () => {
      studentListModal.style.display = "none";
    });
  }

  window.addEventListener("click", (event) => {
    if (event.target === studentListModal) {
      studentListModal.style.display = "none";
    }
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const params = new URLSearchParams(window.location.search);
  const role = params.get("role");

  if (role === "teacher") {
    document.getElementById("teacherPanel").style.display = "block";
    loadApprovedClasses("classListForAddingStudent");
  } else if (role === "student") {
    document.getElementById("studentPanel").style.display = "block";
    loadApprovedClasses("classList");
  } else if (role === "admin") {
    document.getElementById("adminPanel").style.display = "block";
    loadPendingClasses(); // G·ªçi h√†m l·∫•y danh s√°ch l·ªõp ch·ªù duy·ªát
  }
});

async function loadApprovedClasses(selectId) {
  try {
    const approvedClasses = await contract.methods.getApprovedClasses().call();

    const classIds = approvedClasses[0]; // Danh s√°ch ID l·ªõp
    const classNames = approvedClasses[1]; // Danh s√°ch t√™n l·ªõp

    const select = document.getElementById(selectId);
    if (!select) {
      console.error(`‚ùå Kh√¥ng t√¨m th·∫•y select v·ªõi ID: ${selectId}`);
      return;
    }

    select.innerHTML = `<option value="" disabled selected>Ch·ªçn l·ªõp</option>`; // Reset danh s√°ch

    for (let i = 0; i < classIds.length; i++) {
      let option = document.createElement("option");
      option.value = classIds[i];
      option.textContent = `No.${classIds[i]}: ${classNames[i]}`;
      select.appendChild(option);
    }

    console.log(`‚úÖ Danh s√°ch l·ªõp ƒë√£ load v√†o #${selectId} th√†nh c√¥ng`);
  } catch (error) {
    console.error("‚ùå L·ªói khi load danh s√°ch l·ªõp:", error);
  }
}

// G·ªçi h√†m n√†y khi trang admin t·∫£i xong
document.addEventListener("DOMContentLoaded", async function () {
  await loadPendingClasses();
});

//1
async function approveClass(classId) {
  try {
    console.log(`Starting to approve class ${classId}`);

    // Get current gas price and add a small buffer
    const gasPrice = await web3.eth.getGasPrice();
    const gasPriceWithBuffer = Math.floor(Number(gasPrice) * 1.1).toString();

    console.log(`Gas price: ${gasPriceWithBuffer}`);

    // Send transaction with explicit gas parameters
    const result = await contract.methods.approveClass(classId).send({
      from: accounts[0],
      gas: 300000,
      gasPrice: gasPriceWithBuffer,
    });

    console.log("Transaction successful:", result);
    alert("‚úÖ L·ªõp ƒë√£ ƒë∆∞·ª£c duy·ªát!");
    loadPendingClasses(); // C·∫≠p nh·∫≠t danh s√°ch l·ªõp ch·ªù duy·ªát
  } catch (error) {
    console.error("‚ùå L·ªói khi duy·ªát l·ªõp:", error);
    // More detailed error logging
    if (error.message) console.error("Error message:", error.message);
    if (error.code) console.error("Error code:", error.code);
    alert(`L·ªói: ${error.message ? error.message : "Unknown error"}`);
  }
}

async function rejectClass(classId) {
  try {
    console.log(`Starting to reject class ${classId}`);

    // Get current gas price and add a small buffer
    const gasPrice = await web3.eth.getGasPrice();
    const gasPriceWithBuffer = Math.floor(Number(gasPrice) * 1.1).toString();

    console.log(`Gas price: ${gasPriceWithBuffer}`);

    // Send transaction with explicit gas parameters
    const result = await contract.methods.rejectClass(classId).send({
      from: accounts[0],
      gas: 300000,
      gasPrice: gasPriceWithBuffer,
    });

    console.log("Transaction successful:", result);
    alert("‚ùå L·ªõp ƒë√£ b·ªã t·ª´ ch·ªëi!");
    loadPendingClasses(); // C·∫≠p nh·∫≠t danh s√°ch l·ªõp ch·ªù duy·ªát
  } catch (error) {
    console.error("‚ùå L·ªói khi t·ª´ ch·ªëi l·ªõp:", error);
    // More detailed error logging
    if (error.message) console.error("Error message:", error.message);
    if (error.code) console.error("Error code:", error.code);
    alert(`L·ªói: ${error.message ? error.message : "Unknown error"}`);
  }
}
let adminAddress = localStorage.getItem("adminAddress") || null;

async function connectWallet() {
  if (window.ethereum) {
    try {
      console.log("üîó K·∫øt n·ªëi MetaMask...");
      web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: "eth_requestAccounts" });

      accounts = await web3.eth.getAccounts();
      console.log("‚úÖ ƒê√£ k·∫øt n·ªëi v·ªõi t√†i kho·∫£n:", accounts[0]);

      document.getElementById(
        "walletAddress"
      ).innerText = `üü¢ ƒê√£ k·∫øt n·ªëi: ${accounts[0]}`;
      contract = new web3.eth.Contract(contractABI, contractAddress);
      console.log("üìú H·ª£p ƒë·ªìng ƒë√£ t·∫£i:", contract);

      // üü¢ Load danh s√°ch l·ªõp ch·ªù duy·ªát
      await loadPendingClasses();
    } catch (error) {
      console.error("‚ùå L·ªói khi k·∫øt n·ªëi MetaMask:", error);
    }
  } else {
    alert("‚ö†Ô∏è B·∫°n c·∫ßn c√†i MetaMask ƒë·ªÉ s·ª≠ d·ª•ng!");
  }
}

async function createClass() {
  const className = document.getElementById("className").value.trim();
  if (!className) return alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n l·ªõp!");

  try {
    await contract.methods.createClass(className).send({ from: accounts[0] });
    alert("‚úÖ L·ªõp h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫°o, ch·ªù Admin duy·ªát!");
    window.location.href = "admin_login.html?role=admin"; // Chuy·ªÉn sang trang Admin
  } catch (error) {
    console.error("‚ùå L·ªói khi t·∫°o l·ªõp:", error);
  }
}
async function loadPendingClasses() {
  if (!contract) {
    console.error("‚ùå H·ª£p ƒë·ªìng ch∆∞a ƒë∆∞·ª£c t·∫£i.");
    return;
  }

  try {
    console.log("üìå ƒêang t·∫£i danh s√°ch l·ªõp ch·ªù duy·ªát...");
    const result = await contract.methods.getPendingClasses().call();
    console.log("‚úÖ D·ªØ li·ªáu l·ªõp ch·ªù:", result);

    const pendingClassesList = document.getElementById("pendingClassesList");
    if (!pendingClassesList) {
      console.error("‚ùå Kh√¥ng t√¨m th·∫•y element pendingClassesList");
      return;
    }

    pendingClassesList.innerHTML = ""; // X√≥a danh s√°ch c≈© tr∆∞·ªõc khi th√™m m·ªõi

    // Web3.js tr·∫£ v·ªÅ gi√° tr·ªã d∆∞·ªõi d·∫°ng c√°c thu·ªôc t√≠nh s·ªë (0, 1, 2)
    const classIds = result[0]; // M·∫£ng ID l·ªõp
    const classNames = result[1]; // M·∫£ng t√™n l·ªõp
    const teachers = result[2]; // M·∫£ng ƒë·ªãa ch·ªâ gi√°o vi√™n

    if (!classIds || !classNames || !teachers) {
      console.error("‚ùå D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá:", result);
      return;
    }

    for (let i = 0; i < classIds.length; i++) {
      const li = document.createElement("li");
      li.innerHTML = `
        <strong>${classNames[i]}</strong> (GV: ${teachers[i]}) 
        <button onclick="approveClass(${classIds[i]})">‚úÖ Duy·ªát</button>
        <button onclick="rejectClass(${classIds[i]})">‚ùå T·ª´ ch·ªëi</button>
      `;
      pendingClassesList.appendChild(li);
    }
  } catch (error) {
    console.error("‚ùå L·ªói khi t·∫£i danh s√°ch l·ªõp ch·ªù duy·ªát:", error);
    console.error("Chi ti·∫øt l·ªói:", error.message);
  }
}

async function getAdminAddress() {
  const adminAddress = await contract.methods.getAdmin().call();
  return adminAddress.toLowerCase();
}
async function loginWithMetaMask() {
  if (window.ethereum) {
    try {
      const web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: "eth_requestAccounts" });

      const accounts = await web3.eth.getAccounts();
      const userAddress = accounts[0]; // L·∫•y ƒë·ªãa ch·ªâ v√≠ ng∆∞·ªùi d√πng

      console.log("üîπ ƒê·ªãa ch·ªâ v√≠:", userAddress);

      const adminAddress = "0xD04B8057460F760dca8CEF697e596dfc10a9Ec9e";
      const message =
        "X√°c th·ª±c ƒëƒÉng nh·∫≠p Admin v√†o h·ªá th·ªëng Blockchain Attendance";

      const signature = await window.ethereum.request({
        method: "personal_sign",
        params: [message, userAddress],
      });

      console.log("‚úÖ K√Ω th√†nh c√¥ng:", signature);

      if (userAddress.toLowerCase() === adminAddress.toLowerCase()) {
        console.log("üîì ƒêƒÉng nh·∫≠p th√†nh c√¥ng v·ªõi vai tr√≤ Admin");
        // ·∫®n n√∫t ƒëƒÉng nh·∫≠p
        document.querySelector(
          "button[onclick='loginWithMetaMask()']"
        ).style.display = "none";

        // ·∫®n th√¥ng b√°o l·ªói n·∫øu c√≥
        document.getElementById("errorMessage").style.display = "none";

        // Hi·ªÉn th·ªã th√¥ng b√°o ƒëƒÉng nh·∫≠p th√†nh c√¥ng
        const loginStatusElement = document.createElement("div");
        loginStatusElement.innerHTML = `<p class="success-message">‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng v·ªõi ƒë·ªãa ch·ªâ: ${userAddress}</p>`;
        loginStatusElement.className = "login-status";

        // Th√™m v√†o tr∆∞·ªõc adminPanel
        const adminPanel = document.getElementById("adminPanel");
        adminPanel.parentNode.insertBefore(loginStatusElement, adminPanel);

        // Hi·ªÉn th·ªã danh s√°ch l·ªõp
        adminPanel.style.display = "block";

        // Load danh s√°ch l·ªõp ch·ªù duy·ªát
        await loadPendingClasses();
      } else {
        console.log("‚ùå ƒê·ªãa ch·ªâ v√≠ kh√¥ng kh·ªõp v·ªõi ƒë·ªãa ch·ªâ Admin");
        document.getElementById("errorMessage").style.display = "block";
      }
    } catch (error) {
      console.error("‚ùå L·ªói khi ƒëƒÉng nh·∫≠p:", error);
      document.getElementById("errorMessage").innerText =
        "L·ªói khi k·∫øt n·ªëi MetaMask!";
      document.getElementById("errorMessage").style.display = "block";
    }
  } else {
    alert("‚ö†Ô∏è B·∫°n c·∫ßn c√†i MetaMask ƒë·ªÉ ƒëƒÉng nh·∫≠p!");
  }
}

async function addStudent() {
  const classId = document.getElementById("classListForAddingStudent")?.value;
  const studentAddress = document
    .getElementById("studentAddress")
    ?.value.trim();
  if (!studentAddress)
    return showSnackbar("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ v√≠ c·ªßa h·ªçc sinh!");

  try {
    await contract.methods
      .addStudent(classId, studentAddress)
      .send({ from: accounts[0] });
    showSnackbar("‚úÖ H·ªçc sinh ƒë√£ ƒë∆∞·ª£c th√™m v√†o l·ªõp!");
  } catch (error) {
    console.error("‚ùå L·ªói khi th√™m h·ªçc sinh:", error);
  }
}

async function markAttendance() {
  const classId = document.getElementById("classList")?.value;
  if (!classId) return showSnackbar("‚ö†Ô∏è Vui l√≤ng ch·ªçn l·ªõp h·ªçc!");

  try {
    await contract.methods
      .markAttendance(classId, true)
      .send({ from: accounts[0] })
      .on("receipt", () => showSnackbar("‚úÖ ƒêi·ªÉm danh th√†nh c√¥ng!"));
  } catch (error) {
    console.error("‚ùå L·ªói khi ƒëi·ªÉm danh:", error);
  }
}

async function viewAttendance() {
  try {
    const history = document.getElementById("attendanceHistory");
    history.innerHTML = "";

    const studentAddress = accounts[0];
    console.log("üìå ƒê·ªãa ch·ªâ sinh vi√™n:", studentAddress);

    if (!studentAddress) {
      showSnackbar(
        "‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc khi xem l·ªãch s·ª≠ ƒëi·ªÉm danh."
      );
      return;
    }

    const totalClasses = Number(
      await contract.methods.getTotalClasses().call()
    );
    console.log("üìå T·ªïng s·ªë l·ªõp:", totalClasses);

    for (let i = 1; i <= totalClasses; i++) {
      const attendanceCount = await contract.methods
        .getAttendanceCount(i, studentAddress)
        .call();

      // üî• L·∫•y th√¥ng tin l·ªõp h·ªçc t·ª´ h·ª£p ƒë·ªìng
      const classData = await contract.methods.classes(i).call();
      const className = classData.name; // T√™n l·ªõp

      for (let j = 0; j < attendanceCount; j++) {
        const record = await contract.methods
          .getAttendanceRecord(i, studentAddress, j)
          .call();

        const li = document.createElement("li");
        li.innerText = `üìö ${className}: ${
          record[0] ? "‚úÖ C√≥ m·∫∑t" : "‚ùå V·∫Øng"
        } - ${new Date(Number(record[1]) * 1000).toLocaleString()}`;
        history.appendChild(li);
      }
    }
  } catch (error) {
    console.error("‚ùå L·ªói khi xem l·ªãch s·ª≠ ƒëi·ªÉm danh:", error);
  }
}

function showSnackbar(message, type = "info") {
  const snackbar = document.getElementById("snackbar");

  // X√≥a c√°c class c≈© v√† th√™m class m·ªõi
  snackbar.className = "show";
  snackbar.classList.add(type);

  // Hi·ªÉn th·ªã n·ªôi dung snackbar
  snackbar.innerText = message;

  // ·∫®n sau 3 gi√¢y
  setTimeout(() => {
    snackbar.classList.remove("show");
  }, 3000);
}
